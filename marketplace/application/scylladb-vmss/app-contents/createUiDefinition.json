{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "resourceTypes": [
      "Microsoft.Compute/virtualMachineScaleSets",
      "Microsoft.Network/virtualNetworks",
      "Microsoft.Network/networkSecurityGroups"
    ],
    "basics": [
      {
        "name": "vmssName",
        "type": "Microsoft.Common.TextBox",
        "label": "Virtual machine scale set name",
        "toolTip": "The virtual machine scale set name.",
        "constraints": {
          "required": true,
          "validations": [
            {
              "regex": "^([a-zA-Z0-9-]{0,14}[a-zA-Z0-9]){1}$",
              "message": "The virtual machine name can only contain alphanumeric values and hyphens, but may not end with a hyphen. The name must be between 1-15 characters."
            }
          ]
        },
        "visible": true
      },
      {
        "name": "vmssSku",
        "type": "Microsoft.Compute.SizeSelector",
        "label": "Size",
        "toolTip": "Select a VM size to support the workload that you want to run. The size that you choose then determines factors such as processing power, memory, and storage capacity. Azure offers a wide variety of sizes to support many types of uses. Azure charges an hourly price based on the VM's size and operating system.<br>[Learn more about Virtual Machine sizes](http://go.microsoft.com/fwlink/?LinkId=2079859)",
        "recommendedSizes": [
          "Standard_D4ds_v4"
        ],
        "constraints": {
          "required": true
        },
        "osPlatform": "Windows",
        "imageReference": {
          "publisher": "MicrosoftWindowsServer",
          "offer": "WindowsServer",
          "sku": "2019-Datacenter"
        }
      },
      {
        "name": "adminUsername",
        "type": "Microsoft.Compute.UserNameTextBox",
        "label": "Admin username",
        "toolTip": "The administrator username for the VM",
        "osPlatform": "Windows"
      },
      {
        "name": "adminPassword",
        "type": "Microsoft.Compute.CredentialsCombo",
        "label": {
          "password": "Password",
          "confirmPassword": "Confirm password"
        },
        "toolTip": {
          "password": "The administrator password for the VM"
        },
        "constraints": {
          "required": true
        },
        "options": {
          "hideConfirmation": false
        },
        "osPlatform": "Windows",
        "visible": true
      },
      {
        "name": "imageLocation",
        "type": "Microsoft.Common.DropDown",
        "label": "Image Type",
        "defaultValue": "Marketplace",
        "toolTip": "Select which Scylla DB image to use",
        "multiselect": false,
        "selectAll": false,
        "filter": false,
        "filterPlaceholder": "Filter items ...",
        "multiLine": false,
        "defaultDescription": "Select which Scylla DB image to use",
        "constraints": {
            "allowedValues": [
                {
                    "label": "Marketplace",
                    "description": "Azure Marketplace, supported by Scylla DB",
                    "value": "marketplace"
                },
                {
                    "label": "Gallery",
                    "description": "Community editon",
                    "value": "gallery"
                }
            ],
            "required": true
        },
        "visible": true
      }
    ],
    "steps": [
      {
        "name": "networkConfig",
        "label": "Networking",
        "subLabel": {
          "preValidation": "Configure networking",
          "postValidation": "Done"
        },
        "bladeTitle": "Networking",
        "elements": [
          {
            "name": "networkingInfo",
            "type": "Microsoft.Common.TextBlock",
            "visible": true,
            "options": {
              "text": "Define network connectivity for your virtual machine by configuring network interface card (NIC) settings. You can control ports, inbound and outbound connectivity with security group rules, or place behind an existing load balancing solution.",
              "link": {
                "label": "Learn more about VMSS networking",
                "uri": "https://learn.microsoft.com/en-au/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-networking"
              }
            }
          },
          {
            "name": "virtualNetwork",
            "type": "Microsoft.Network.VirtualNetworkCombo",
            "label": {
              "virtualNetwork": "Virtual network",
              "subnets": "Subnets"
            },
            "toolTip": {
              "virtualNetwork": "Virtual networks are logically isolated from each other in Azure. You can configure their IP address ranges, subnets, route tables, gateways, and security settings, much like a traditional network in your data center. Virtual machines in the same virtual network can access each other by default.",
              "subnets": "A subnet is a range of IP addresses in your virtual network, which can be used to isolate virtual machines from each other or from the Internet."
            },
            "defaultValue": {
              "name": "[concat(basics('vmName'), '-vnet')]",
              "addressPrefixSize": "/24"
            },
            "options": {
              "hideExisting": true
            },
            "constraints": {
              "minAddressPrefixSize": "/24"
            },
            "subnets": {
              "subnet1": {
                "label": "Subnet",
                "defaultValue": {
                  "name": "default",
                  "addressPrefixSize": "/26"
                },
                "constraints": {
                  "minAddressPrefixSize": "/26",
                  "minAddressCount": 12,
                  "requireContiguousAddresses": false
                }
              }
            }
          }
        ]
      },
      {
        "name": "scaling",
        "label": "Scaling",
        "subLabel": {
          "preValidation": "Configure VMSS scaling",
          "postValidation": "Done"
        },
        "bladeTitle": "Scaling",
        "elements": [
          {
            "name": "scalingInfo",
            "type": "Microsoft.Common.TextBlock",
            "visible": true,
            "options": {
              "text": "An Azure virtual machine scale set can automatically increase or decrease the number of VM instances that run your application. This automated and elastic behavior reduces the management overhead to monitor and optimize the performance of your application.",
              "link": {
                "label": "Learn more about VMSS scaling",
                "uri": "https://learn.microsoft.com/en-au/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-autoscale-overview"
              }
            }
          },
          {
            "name": "vmssInstanceCount",
            "type": "Microsoft.Common.TextBox",
            "label": "Initial instance count",
            "toolTip": "The number of virtual machines in the scale set (0 - 1000).",
            "defaultValue": 2,
            "visible": true,
            "constraints": {
              "required": true,
              "validations": [
                {
                  "regex": "^[0-9]+$",
                  "message": "Only integers are allowed."
                },
                {
                  "isValid": "[and(greaterOrEquals(steps('scaling').vmssInstanceCount, 0), lessOrEquals(steps('scaling').vmssInstanceCount, 1000))]",
                  "message": "Must be between 0 and 1000."
                }
              ]
            }
          }
        ]
      }
    ],
    "outputs": {
      "location": "[location()]",
      "vmssName": "[basics('vmssName')]",
      "vmssSku": "[basics('vmssSku')]",
      "administratorLogin": "[basics('adminUsername')]",
      "passwordAdministratorLogin": "[basics('adminPassword').password]",
      "imageLocation": "[basics('imageLocation')]",
      "vnetName": "[steps('networkConfig').virtualNetwork.name]",
      "vnetAddressPrefix": "[steps('networkConfig').virtualNetwork.addressPrefixes]",
      "networkSecurityGroupName": "[steps('networkConfig').virtualNetwork.resourceGroup]",
      "subnetName": "[steps('networkConfig').virtualNetwork.subnets.subnet1.name]",
      "subnetAddressPrefix": "[steps('networkConfig').virtualNetwork.subnets.subnet1.addressPrefix]",
      "vmssInstanceCount": "[int(steps('scaling').vmssInstanceCount)]"      
    }
  }
}
